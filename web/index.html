<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo AI Analyzer - Gemini</title>
  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: #1a73e8; color: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
    header h1 { font-size: 1.5rem; }
    .settings { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .settings label { display: block; margin-bottom: 5px; font-weight: 500; }
    .settings input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .settings input[type="password"] { font-family: monospace; }
    .upload-area { background: white; border: 2px dashed #ddd; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: border-color 0.3s; }
    .upload-area:hover { border-color: #1a73e8; }
    .upload-area.dragover { border-color: #1a73e8; background: #e8f0fe; }
    .upload-area input { display: none; }
    .btn { background: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #1557b0; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .photo-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .photo-card img { width: 100%; height: 150px; object-fit: cover; }
    .photo-card .info { padding: 10px; font-size: 12px; }
    .photo-card .info .filename { font-weight: 500; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .photo-card .info .field { color: #666; margin-bottom: 2px; }
    .photo-card .info .field span { color: #333; }
    .photo-card.analyzing { opacity: 0.7; }
    .photo-card.done { border-left: 4px solid #34a853; }
    .progress { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .progress-bar .fill { height: 100%; background: #1a73e8; transition: width 0.3s; }
    .progress-text { margin-top: 10px; font-size: 14px; color: #666; }
    .results { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .results h3 { margin-bottom: 10px; }
    .results pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 400px; overflow-y: auto; }
    .actions { display: flex; gap: 10px; margin-bottom: 20px; }
    .log { background: #263238; color: #aed581; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
    .log .error { color: #ef5350; }
    .log .success { color: #66bb6a; }
    .log .info { color: #42a5f5; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Photo AI Analyzer - Gemini</h1>
    </header>

    <div class="settings">
      <label for="apiKey">Gemini API Key</label>
      <input type="password" id="apiKey" placeholder="AIzaSy..." />
      <small style="color:#666; display:block; margin-top:5px;">APIキーはブラウザのローカルストレージに保存されます</small>
    </div>

    <div class="upload-area" id="uploadArea">
      <p>クリックまたはドラッグ&ドロップで写真を追加</p>
      <input type="file" id="fileInput" multiple accept="image/*" />
    </div>

    <div class="actions">
      <button class="btn" id="analyzeBtn" disabled>解析開始</button>
      <button class="btn" id="clearBtn" style="background:#666;">クリア</button>
      <button class="btn" id="exportBtn" style="background:#34a853;" disabled>JSON出力</button>
    </div>

    <div class="progress" id="progressSection" style="display:none;">
      <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">準備中...</div>
    </div>

    <div class="log" id="log"></div>

    <div class="photos" id="photosGrid"></div>

    <div class="results" id="resultsSection" style="display:none;">
      <h3>解析結果 (JSON)</h3>
      <pre id="resultsJson"></pre>
    </div>
  </div>

  <script type="module">
    import { GoogleGenAI } from '@google/genai';

    // State
    let photos = [];
    let results = [];
    let genAI = null;

    // Elements
    const apiKeyInput = document.getElementById('apiKey');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const photosGrid = document.getElementById('photosGrid');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const logEl = document.getElementById('log');
    const resultsSection = document.getElementById('resultsSection');
    const resultsJson = document.getElementById('resultsJson');

    // Load saved API key
    const savedKey = localStorage.getItem('gemini_api_key');
    if (savedKey) apiKeyInput.value = savedKey;

    apiKeyInput.addEventListener('change', () => {
      localStorage.setItem('gemini_api_key', apiKeyInput.value);
      log('APIキーを保存しました', 'success');
    });

    // Logging
    function log(msg, type = '') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // File handling
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;

        const base64 = await fileToBase64(file);
        photos.push({
          file,
          fileName: file.name,
          base64,
          mimeType: file.type,
          result: null
        });
      }
      renderPhotos();
      updateButtons();
      log(`${files.length}枚の写真を追加しました`, 'info');
    }

    function fileToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });
    }

    function renderPhotos() {
      photosGrid.innerHTML = photos.map((p, i) => `
        <div class="photo-card ${p.result ? 'done' : ''}" id="photo-${i}">
          <img src="data:${p.mimeType};base64,${p.base64}" alt="${p.fileName}" />
          <div class="info">
            <div class="filename">${p.fileName}</div>
            ${p.result ? `
              <div class="field">区分: <span>${p.result.photoCategory || '-'}</span></div>
              <div class="field">工種: <span>${p.result.workType || '-'}</span></div>
              <div class="field">種別: <span>${p.result.variety || '-'}</span></div>
            ` : '<div class="field" style="color:#999;">未解析</div>'}
          </div>
        </div>
      `).join('');
    }

    function updateButtons() {
      analyzeBtn.disabled = photos.length === 0 || !apiKeyInput.value;
      exportBtn.disabled = results.length === 0;
    }

    clearBtn.addEventListener('click', () => {
      photos = [];
      results = [];
      renderPhotos();
      updateButtons();
      resultsSection.style.display = 'none';
      log('クリアしました', 'info');
    });

    exportBtn.addEventListener('click', () => {
      const json = JSON.stringify(results, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'analysis_result.json';
      a.click();
      URL.revokeObjectURL(url);
      log('JSONをダウンロードしました', 'success');
    });

    // Analysis
    analyzeBtn.addEventListener('click', async () => {
      if (!apiKeyInput.value) {
        log('APIキーを入力してください', 'error');
        return;
      }

      try {
        genAI = new GoogleGenAI({ apiKey: apiKeyInput.value });
        await analyzePhotos();
      } catch (e) {
        log(`エラー: ${e.message}`, 'error');
      }
    });

    async function analyzePhotos() {
      const batchSize = 5;
      const batches = [];
      for (let i = 0; i < photos.length; i += batchSize) {
        batches.push(photos.slice(i, i + batchSize));
      }

      progressSection.style.display = 'block';
      results = [];

      for (let i = 0; i < batches.length; i++) {
        const batch = batches[i];
        const progress = ((i + 1) / batches.length) * 100;
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `バッチ ${i + 1}/${batches.length} (${batch.length}枚) 処理中...`;

        log(`バッチ ${i + 1} 解析開始: ${batch.map(p => p.fileName).join(', ')}`, 'info');

        try {
          const batchResults = await analyzeBatch(batch);

          for (const result of batchResults) {
            const photo = photos.find(p => p.fileName === result.fileName);
            if (photo) {
              photo.result = result;
              results.push(result);
            }
          }

          renderPhotos();
          log(`バッチ ${i + 1} 完了: ${batchResults.length}件`, 'success');
        } catch (e) {
          log(`バッチ ${i + 1} エラー: ${e.message}`, 'error');
        }
      }

      progressText.textContent = `完了: ${results.length}枚`;
      resultsSection.style.display = 'block';
      resultsJson.textContent = JSON.stringify(results, null, 2);
      updateButtons();
      log('全解析完了', 'success');
    }

    async function analyzeBatch(batch) {
      const inputs = batch.map(p => ({
        inlineData: { data: p.base64, mimeType: p.mimeType }
      }));

      const systemPrompt = `You are a construction photo analyzer. Analyze each photo and extract:
- photoCategory: 施工状況, 品質管理, 出来形管理, 材料検収, 安全管理, 使用材料, etc.
- workType: 工種 (e.g., 舗装工, 区画線工)
- variety: 種別 (e.g., アスファルト舗装, 溶融式区画線)
- detail: 細別
- station: 測点 (e.g., NO.10+5.0)
- remarks: 備考
- description: 写真の説明
- reasoning: 判定根拠

Return JSON array matching input order.`;

      const prompt = `Analyze these ${batch.length} photos.
Return a JSON array with objects containing: fileName, photoCategory, workType, variety, detail, station, remarks, description, reasoning.
Order must match input order.

Photo fileNames: ${batch.map(p => p.fileName).join(', ')}`;

      const result = await genAI.models.generateContent({
        model: 'gemini-2.0-flash',
        contents: [{ role: 'user', parts: [...inputs, { text: prompt }] }],
        config: {
          systemInstruction: systemPrompt,
          responseMimeType: 'application/json',
          temperature: 0.1
        }
      });

      const text = result.text || '[]';
      try {
        const parsed = JSON.parse(text);
        return Array.isArray(parsed) ? parsed : parsed.results || [];
      } catch {
        log('JSONパースエラー', 'error');
        return [];
      }
    }

    updateButtons();
    log('Photo AI Analyzer 起動', 'info');
  </script>
</body>
</html>
