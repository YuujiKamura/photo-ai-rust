# Phase 4 追加: Excelマスタ入力対応

## 背景

### ユーザー要望
> エクセルをマスタにして、ユーザー側で容易に書き換えられる形式にしたい

### 私がやったこと
1. 最初: Excelマスタ形式を勝手に設計 → 既存コードと互換性なし
2. 修正: 既存JSON構造に合わせた → ユーザー要望（Excel編集可能）を忘れた

### 正しいアプローチ
**両立させる**: Excel入力 → JSON構造に変換 → 既存ロジックで照合

---

## 設計

### Excelマスタの形式

| 写真区分 | 工種 | 種別 | 細別 | 備考 | matchPatterns |
|---------|------|------|------|------|---------------|
| 品質管理写真 | 舗装工 | 舗装打換え工 | 表層工 | アスファルト混合物温度測定 | 温度管理,到着温度,敷均し温度 |
| 品質管理写真 | 舗装工 | 舗装打換え工 | 上層路盤工 | 現場密度測定 | 密度測定,RI計器,砂置換法 |
| 出来形管理写真 | 舗装工 | 舗装打換え工 | 上層路盤工 | 不陸整正出来形 | 路盤出来形,出来形検測,基準高 |

### 処理フロー

```
Excel (.xlsx)
    ↓ calamine で読み込み
フラットな行データ
    ↓ 変換
JSON構造（既存形式）
    ↓ 既存ロジック
照合結果
```

### ファイル拡張子による分岐

```rust
match ext {
    "xlsx" | "xls" => load_from_excel(path)?,  // Excel → JSON変換
    "json" => load_from_json(path)?,            // 既存JSON直接読み込み
    _ => return Err(...)
}
```

---

## 実装計画

### Step 1: Cargo.toml
- calamine を再追加

### Step 2: matcher/mod.rs
- `load_from_excel()` 関数を追加
- Excel行 → JSON構造への変換ロジック
- 拡張子による分岐

### Step 3: テスト
- Excelからの読み込みテスト
- JSON/Excel両方で同じ結果になることを確認

---

## 教訓（Issue #003 として記録）

「既存コードを見た」だけでは不十分。
「ユーザー要望」と「既存コード」の**両立**を考える必要がある。

| やったこと | 問題 |
|-----------|------|
| 既存コードを見ずに実装 | 互換性なし |
| 既存コードに合わせて実装 | ユーザー要望を忘れた |
| **両立を考えて実装** | ✅ 正しいアプローチ |
